---
title: "phage cocktail modelling paper"
author: "Bogna Smug"
date: "6/3/2020"
output:
  html_document: 
    number_sections: true
  pdf_document: default
---


```{r setup, include=FALSE}
library(xlsx)
library(ggplot2)
library(dplyr)

figures_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/manuskrypt/IJMS/version_2021_02_01/figures/theoretical/"
figures_data_path = paste0(figures_path, "figures_data.xlsx")
experimental_figures_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/manuskrypt/IJMS/version_2021_02_01/figures/experimental/"

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
text_size = 18
fig.width = 18
fig.height = 12
save_data = FALSE


#source('~/MGG Dropbox/Bogna Smug/Z_Drulis_Kawa/scripts/version5_2020_05/compare_coctail_and_depo_version_with_delayed_phages.R')
source('/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/phage_cocktail_efficiency/shiny_app/PhARTNER/R/helpers.R')
VisualisationConstants = GetVisualisationConstants(text_size)
my_theme = VisualisationConstants$my_theme
colors = VisualisationConstants$colors
linetypes = VisualisationConstants$linetypes
linesizes = VisualisationConstants$linesizes
# for visualisations of the expermiental data
# to avoid meaningless low numbers assume that 10^6 CFU/mL is the lowest we can get 
# CFU ABOVE OD THRESHOLD: OD = 0.55 CFU = 6.3*10^6 [CFU/mL]
minCFU=6.3*10^6

CFUFromOD = function(OD) {
  #CFU = as.numeric(mod$coefficients[1]) + as.numeric(mod$coefficients[2])*exp(OD)
  # this will give us CFU/mL
  CFU = max(-1079035517 + 1014525658*exp(OD), minCFU)
  # this will give us CFU/L
  #CFU = 1000*CFU
  return(CFU)
}
# when plotting
YMIN = minCFU
YMAX = 2.5*10^9

#ODfromCFU = function(CFU) {
#  return(log((CFU+1079035517)/1014525658))
#}


```

```{r real-data}
TREATMENTS = c("no phage", "depo-phage (KP34)", "no-depo-phage (KP15/KP27)", "phage cocktail (KP15/KP27 + KP34)", "no-depo-phage (KP15/KP27)", "phage cocktail (KP15/KP27 + KP34)","External depo", "no-depo-phage+depo (KP15/KP27 + KP34p57)", "no-depo-phage+depo (KP15/KP27 + KP34p57)" )
LoadExperimentalData = function(experimental_data_path, sheet_name, range_mean, range_sd,
                                treatments = TREATMENTS) {

  final_data_time=readxl::read_excel(path = experimental_data_path, 
                  sheet = sheet_name,
                  range = "A5:A53",
                  col_names = FALSE) 
  names(final_data_time) = "time"
  
  final_data_mean=readxl::read_excel(path = experimental_data_path, 
                  sheet = sheet_name,
                  range = range_mean,
                  col_names = TRUE) %>%
    cbind(final_data_time) %>%
    tidyr::gather(key = "Treatment", value = "CFU_mean", -c(time))
  
  final_data_sd=readxl::read_excel(path = experimental_data_path, 
                  sheet = sheet_name,
                  range = range_sd,
                  col_names = TRUE) %>%
    cbind(final_data_time) %>%
    tidyr::gather(key = "Treatment", value = "CFU_sd", -c(time))
  
  final_data = inner_join(final_data_mean, final_data_sd) %>%
    rowwise() %>%
    mutate(all_bacteria_CFU_per_mL = max(CFU_mean, minCFU),
           ymin = max(minCFU, all_bacteria_CFU_per_mL - CFU_sd),
           ymax = all_bacteria_CFU_per_mL + CFU_sd) 
  if (!(is.null(treatments))) {
    final_data = final_data %>%
          mutate(Treatment = plyr::mapvalues(Treatment, 
                                       from = c("no phage","KP34","KP15","KP34 + KP15", "KP27", "KP34 + KP27", "depo34", "depo34 + KP15", "depo34 + KP27"), 
                                       to = treatments))
  }
return(final_data)
}

TREATMENTS_FIGs3 = c("no phage", "depo-phage (KP34)", "no-depo-phage (KP15)", "phage cocktail (KP15 + KP34)", "no-depo-phage (KP27)", "phage cocktail (KP27 + KP34)","External depo", "no-depo-phage+depo (KP15 + KP34p57)", "no-depo-phage+depo (KP27 + KP34p57)" )
```

```{r, warning=FALSE, message=FALSE}
final_data_fig1a_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Dane do papier_model_CFU_gms.xlsx",
  sheet_name = "Fig 1a MOI10_t",
  range_mean = "B4:E53",
  range_sd = "F4:I53") %>%
  mutate(
    #scenario = "Kp77 & KP34 & KP15")
    #scenario = "Kp77 under phage treatment (no-depo-phage = KP15)")
    scenario = "Experimental data from Kp77 treatment with KP34/KP15 phages")

final_data_fig1b_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Dane do papier_model_CFU_gms.xlsx",
  sheet_name = "Fig 1b MOI10_t",
    range_mean = "B4:E53",
  range_sd = "F4:I53") %>%
  mutate(
    #scenario = "Kp77 & KP34 & KP27")
    #scenario = "Kp77 under phage treatment (no-depo-phage = KP27)")
  scenario = "Experimental data from Kp77 treatment with KP34/KP27 phages")

final_data_fig3a_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Dane do papier_model_CFU_gms.xlsx",
  sheet_name = "Fig 3a MOI10_t",
  range_mean = "B4:E53",
  range_sd = "F4:I53") %>%
  mutate(
    #scenario = "Kp486 & KP34 & KP15")
    #scenario = "Kp486 under phage treatment  (no-depo-phage = KP15)")
    scenario = "Experimental data from Kp486Å› treatment with KP34/KP15 phages")

final_data_fig4a_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Dane do papier_model_CFU_gms.xlsx",
  sheet_name = "Fig 4a MOI10_t",
  range_mean = "B4:G53",
  range_sd = "H4:M53") %>%
  mutate(
    #scenario = "Kp77 & KP34 & KP15 & depo")
    #scenario = "Kp77 under phage treatment  (no-depo-phage = KP15)")
  scenario = "Experimental data from Kp77 treatment with KP34/KP15 phages")

final_data_fig4b_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Dane do papier_model_CFU_gms.xlsx",
  sheet_name = "Fig 4b MOI10_t",
  range_mean = "B4:G53",
  range_sd = "H4:M53") %>%
  mutate(
    #scenario = "Kp77 & KP34 & KP27 & depo")
    #scenario = "Kp77 under phage treatment  (no-depo-phage = KP27)")
  scenario = "Experimental data from Kp77 treatment with KP34/KP27 phages")
final_data_fig5a_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Fig 5a i Fig 5b.xlsx",
  sheet_name = "Fig 5a_t",
  range_mean = "B4:E53",
  range_sd = "F4:I53") %>%
  mutate(
    #scenario = "Kp77 & KP34 & KP15 & depo"
    #scenario = "Kp77 under phage treatment  (no-depo-phage = KP15)")
    scenario = "Experimental data from Kp77 treatment with KP34/KP15 phages") %>%
  mutate(MOI = "MOI 10")

final_data_fig5a_moi1 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Fig 5a i Fig 5b.xlsx",
  sheet_name = "Fig 5a_t",
  range_mean = "L4:O53",
  range_sd = "P4:S53") %>%
  mutate(
    #scenario = "Kp77 & KP34 & KP15 & depo") %>%
        #scenario = "Kp77 under phage treatment  (no-depo-phage = KP15)") 
    scenario = "Experimental data from Kp77 treatment with KP34/KP15 phages")%>%
  mutate(MOI = "MOI 1")

final_data_fig5a_moi01 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Fig 5a i Fig 5b.xlsx",
  sheet_name = "Fig 5a_t",
  range_mean = "V4:Y53",
  range_sd = "Z4:AC53") %>%
  mutate(#scenario = "Kp77 & KP34 & KP15 & depo")
        #scenario = "Kp77 under phage treatment  (no-depo-phage = KP15)")
    scenario = "Experimental data from Kp77 treatment with KP34/KP15 phages")%>%
  mutate(MOI = "MOI 0.1")

final_data_fig5b_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Fig 5a i Fig 5b.xlsx",
  sheet_name = "Fig 5b_t",
  range_mean = "B4:E53",
  range_sd = "F4:I53") %>%
  mutate(#scenario = "Kp77 & KP34 & KP27 & depo")
        #scenario = "Kp77 under phage treatment  (no-depo-phage = KP27)")
    scenario = "Experimental data from Kp77 treatment with KP34/KP27 phages")%>%
  mutate(MOI = "MOI 10")

final_data_fig5b_moi1 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Fig 5a i Fig 5b.xlsx",
  sheet_name = "Fig 5b_t",
  range_mean = "L4:O53",
  range_sd = "P4:S53") %>%
  mutate(#scenario = "Kp77 & KP34 & KP27 & depo") 
        #scenario = "Kp77 under phage treatment  (no-depo-phage = KP27)") 
    scenario = "Experimental data from Kp77 treatment with KP34/KP27 phages") %>%
  mutate(MOI = "MOI 1")

final_data_fig5b_moi01 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Fig 5a i Fig 5b.xlsx",
  sheet_name = "Fig 5b_t",
  range_mean = "V4:Y53",
  range_sd = "Z4:AC53") %>%
  mutate(#scenario ="Kp77 & KP34 & KP27 & depo"
        #scenario = "Kp77 under phage treatment  (no-depo-phage = KP27)") 
    scenario = "Experimental data from Kp77 treatment with KP34/KP27 phages")%>%
  mutate(MOI = "MOI 0.1")

final_data_fig5a = final_data_fig5a_moi01 %>% 
  rbind(final_data_fig5a_moi1) %>%
  rbind(final_data_fig5a_moi10)
  
final_data_fig5b = final_data_fig5b_moi01 %>% 
  rbind(final_data_fig5b_moi1) %>%
  rbind(final_data_fig5b_moi10)
  

#TREATMENTS_FIGs3 = c("no phage", "depo-phage (KP34)", "no-depo-phage (KP15)", "phage cocktail (KP15 + KP34)", "no-depo-phage (KP27)", "phage cocktail (KP27 + KP34)","External depo", "no-depo-phage+depo (KP15 + KP34p57)", "no-depo-phage+depo (KP27 + KP34p57)" )
final_data_figS3_moi10 = LoadExperimentalData(
  experimental_data_path = "/Users/bognasmug/MGG Dropbox/Bogna Smug/Projects/Z_Drulis_Kawa/data/2021_01_final/Fig 3 dodatek.xlsx",
  sheet_name = "FigS3",
  range_mean = "B4:E53",
  range_sd = "F4:I53",
  treatments = TREATMENTS) %>%
  mutate(
    scenario = "Experimental data from Kp486 treatment with KP34/KP27 phages")
```

```{r override-fig4a-depo-data}
  external_depo_data_5a_moi10  = 	final_data_fig5a_moi10  %>% 
  filter(Treatment == "no-depo-phage+depo (KP15/KP27 + KP34p57)") %>%
  select(-MOI)
	final_data_fig4a_moi10_without_external_depo = final_data_fig4a_moi10 %>% 
	  filter(Treatment != "no-depo-phage+depo (KP15/KP27 + KP34p57)")
	final_data_fig4a_moi10 = dplyr::bind_rows(external_depo_data_5a_moi10, final_data_fig4a_moi10_without_external_depo)
	
	  external_depo_data_5b_moi10  = 	final_data_fig5b_moi10  %>% 
  filter(Treatment == "no-depo-phage+depo (KP15/KP27 + KP34p57)") %>%
  select(-MOI)
	final_data_fig4b_moi10_without_external_depo = final_data_fig4b_moi10 %>% 
	  filter(Treatment != "no-depo-phage+depo (KP15/KP27 + KP34p57)")
	final_data_fig4b_moi10 = dplyr::bind_rows(external_depo_data_5b_moi10, final_data_fig4b_moi10_without_external_depo)

```

```{r}
# save legends only
g =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig1a_moi10)
legend1 = ggpubr::get_legend(g)
l1=ggpubr::as_ggplot(legend1)
ggsave(filename = paste0(figures_path, "legend1",  ".png"), plot = legend1,width = fig.width/2, height = fig.height/2, units = "cm")
g =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig4a_moi10)
legend2 = ggpubr::get_legend(g)
l2=ggpubr::as_ggplot(legend2)
ggsave(filename = paste0(figures_path, "legend2",  ".png"), plot = legend2,width = fig.width/2, height = fig.height/2, units = "cm")



  
g =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig4a_moi10 %>% 
  mutate(Treatment = plyr::revalue(Treatment,c("no-depo-phage (KP15/KP27)" ="no-depo-phage (KP15)", "no-depo-phage+depo (KP15/KP27 + KP34p57)" ="no-depo-phage+depo (KP15 + KP34p57)"))),
  colors = GetVisualisationConstantsFig3()$colors,
  linetypes = GetVisualisationConstantsFig3()$linetypes,
  linesizes = GetVisualisationConstantsFig3()$linesizes)+ theme(legend.background = element_rect(color = NA))

legend3 = ggpubr::get_legend(g)
l3=ggpubr::as_ggplot(legend3)
ggsave(filename = paste0(figures_path, "legend3",  ".png"), plot = legend3,width = fig.width/2, height = fig.height/2, units = "cm")

# generate and save plots

fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig1a_moi10,  ymin = minCFU, legend.position = "none", strip.background.color = "lightblue", text_size = text_size) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4)

print(fig)
ggsave(filename = paste0(experimental_figures_path, "Fig1a",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
ggsave(filename = paste0(experimental_figures_path, "FigS3a",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 

fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig1b_moi10, ymin = minCFU, legend.position = "none", strip.background.color = "lightblue", text_size = text_size) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4)
print(fig)
ggsave(filename = paste0(experimental_figures_path, "Fig1b",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 
ggsave(filename = paste0(experimental_figures_path, "FigS3b",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 

fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig3a_moi10, ymin = minCFU, legend.position = "none", strip.background.color = "lightblue", text_size = text_size) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4) 
print(fig)
ggsave(filename = paste0(experimental_figures_path, "Fig3a",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 
ggsave(filename = paste0(experimental_figures_path, "FigS3c",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 

fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig4a_moi10, ymin = minCFU, legend.position = "none", strip.background.color = "lightblue", text_size = text_size) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4) 
print(fig)
ggsave(filename = paste0(experimental_figures_path, "Fig4a",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 

fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_fig4b_moi10, ymin = minCFU, legend.position = "none", strip.background.color = "lightblue", text_size = text_size) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4) 
print(fig)
ggsave(filename = paste0(experimental_figures_path, "Fig4b",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 


fig=ggplot(data = final_data_fig5a,
           aes(x=time, y=all_bacteria_CFU_per_mL, col = Treatment, linetype = Treatment, size = Treatment)) +
  geom_line() +
  my_theme +
  scale_y_log10() +
  scale_color_manual(values=colors)  +
  scale_linetype_manual(values = linetypes) +
        scale_size_manual(values = linesizes) +
      xlab("time [h]") +
    ylab("bacteria [CFU/mL]") +
    facet_grid(MOI ~scenario ) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4) +
  scale_y_log10(limits = c(YMIN, YMAX)) +
  theme(strip.background =element_rect(fill="lightblue"),
        legend.position = "none")


print(fig)
ggsave(filename = paste0(experimental_figures_path, "Fig5a",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 

fig=ggplot(data = final_data_fig5b,
           aes(x=time, y=all_bacteria_CFU_per_mL, col = Treatment, linetype = Treatment, size = Treatment)) +
  geom_line() +
  my_theme +
  scale_y_log10() +
  scale_color_manual(values=colors)  +
  scale_linetype_manual(values = linetypes) +
      scale_size_manual(values = linesizes) +
      xlab("time [h]") +
    ylab("bacteria [CFU/mL]") +
    facet_grid(MOI ~scenario ) +
  scale_y_log10(limits = c(YMIN, YMAX)) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4) +
  theme(strip.background =element_rect(fill="lightblue"),
        legend.position = "none")
print(fig)
ggsave(filename = paste0(experimental_figures_path, "Fig5b",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 




fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(final_data_figS3_moi10, 
                                                    ymin = minCFU, 
                                                    legend.position = "none", 
                                                    strip.background.color = "lightblue", 
                                                    text_size = text_size) +
  geom_errorbar(aes(ymin = ymin, ymax = ymax), 
                linetype = "solid", size = 1, alpha = 0.4) 
print(fig)
ggsave(filename = paste0(experimental_figures_path, "FigS3d",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm") 

```



```{r set-model-params}
mg_count = (10^12) # we will do mathematical simulations in g/L or mg/mL

default_params = SetDefaultParameters(mg_count)
#default_params$MOI = 1
# PARAMETERS
Tmax = default_params$Tmax
B0  = default_params$B0
MOI =default_params$MOI
G0 = default_params$G0
Vh = default_params$Vh
Kh = default_params$Kh
a = default_params$a
beta_non_depo = default_params$beta_non_depo
beta_depo = default_params$beta_depo
phi_non_depo = default_params$phi_non_depo
phi_depo = default_params$phi_depo
decay = default_params$decay
depo_decay_rate = default_params$depo_decay_rate
e0 =default_params$e0
V_depo = default_params$V_depo
K_depo = default_params$K_depo
epsilonB2toB1 = default_params$epsilonB2toB1
epsilonB1toB2 = default_params$epsilonB1toB2
epsilonB2toB3 = default_params$epsilonB2toB3
epsilonB3toB2 = default_params$epsilonB3toB2
epsilonB1toB3 = default_params$epsilonB1toB3
epsilonB3toB1 = default_params$epsilonB3toB1
```


```{r}
# set all the parameters that we vary
initialPropB2=10^(-4)
highB0=1000*B0
lowB0=B0/1000
lowG0=G0/2
highG0=2*G0
highEpsilonB1toB3 = 10^(-12)
highMOI = MOI
mediumMOI = 1
lowMOI = 0.1
low_phi_depo = phi_depo/20
low_beta_depo = beta_depo/10
low_phi_non_depo = phi_non_depo/20
low_beta_non_depo = beta_non_depo/10
highepsilonB2toB1 = 10*epsilonB2toB1
lowepsilonB2toB1 =0.1*epsilonB2toB1
highepsilontoB3 = 10^(-3)
lowPropPP = 0.01

```

# Introduction TO DO
# Model description TO DO
# Results
## Model reproduces the experimental result that the phage cocktail is more effective than each cocktail in seperation



```{r}
scenario_name = "Fig1c_Default"
colors_no_depo = c("no phage" = "black",
           "depo-phage (KP34)" = "darkgreen",
           "no-depo-phage (KP15/KP27)" = "darkblue",
           "phage cocktail (KP15/KP27 + KP34)" = "darkred")
# Finaly evalutate simulation
simulated_data_default =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo,                                                            
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax)
if (save_data) {
write.xlsx(simulated_data_default, file=figures_data_path, sheetName = scenario_name, append = TRUE)
}
dataFig1c = simulated_data_default %>%
  mutate(scenario = "Main model result")

fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig1c,
                              title_plot = "",
                              colors = colors_no_depo,
                              ymin=YMIN,
                              ymax =YMAX,
                              text_size = text_size,
                              legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, scenario_name,  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
```

Note that:  
i) in the simulations we see very qick growth all the time, whereas in experiments it slows down after 5h.
This is probably because there are some limiting nutrients (other than glucose ) that we do not consider in our model for simplicity.  
ii)  in the simulations bacteria under P_P treatments grows to same density as the bacteria with no phages.  
In experiments they grow to a smaller density. It may be because:  
-in the culture there is not enough oxygen for entire 24h  
- there may be some fitness effects of the mutation

## Model is able to reproduce known scenarios
### Appearance of resistant mutants either via penotypic changes during the experiment or by initial diversity both lead to the same result
Namely regrowth of bacteria after a couple ours of the standard traetment. However, phage cocktail is effective in both cases
<Refer to Bull 2014>

```{r,echo=FALSE, fig.show = "hold", out.width = "49%"}

scenario_name = "Fig1e_No_mutation_but_initial_B_N"
simulated_data =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=0, 
                       epsilonB1toB2=0,
                       epsilonB2toB3=0, 
                       epsilonB3toB2=0,
                       epsilonB1toB3=0, 
                       epsilonB3toB1=0,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax, 
                       propB2init = initialPropB2)
  if (save_data) {   write.xlsx(simulated_data, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }
dataFig1e = simulated_data %>%
  mutate(scenario = "No phenotypic changes & initial B_N")
fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig1e,
                              title_plot = "",
                              colors = colors_no_depo,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, scenario_name,  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")

```


### In absence of any phenotypic changes the standard treatment is effective

```{r,echo=FALSE, fig.show = "hold", out.width = "49%"}
fig =PlotSimulatedPhageAndBacteria(simulated_data_default,
                              title_plot = "Default",
                              colors = colors_no_depo,
                              text_size = text_size) 
print(fig)

scenario_name = "Fig1d_No_mutation"
simulated_data =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=0, 
                       epsilonB1toB2=0,
                       epsilonB2toB3=0, 
                       epsilonB3toB2=0,
                       epsilonB1toB3=0, 
                       epsilonB3toB1=0,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax)

  if (save_data) {   write.xlsx(simulated_data, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }
dataFig1d = simulated_data %>%
  mutate(scenario = "No phenotypic changes")
fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig1d,
                              title_plot = "",
                              colors = colors_no_depo,
                              ymin= YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, scenario_name,  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
```

```{r plot-entire-fig-1, eval = FALSE}
dataFig1 = rbind(final_data_fig1a_moi10 %>%  select(time, Treatment, all_bacteria_CFU_per_mL, scenario), 
                 final_data_fig1b_moi10 %>%  select(time, Treatment, all_bacteria_CFU_per_mL, scenario), 
                 dataFig1c %>% select(time, Treatment, all_bacteria_CFU_per_mL, scenario),
                 dataFig1d %>% select(time, Treatment, all_bacteria_CFU_per_mL, scenario),
                 dataFig1e %>% select(time, Treatment, all_bacteria_CFU_per_mL, scenario))
fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig1,
                              title_plot = "",
                              colors = colors_no_depo,
                              ymin= YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2) +
  theme(legend.position = c(0.9,0.1),
        legend.justification  = c(1,0))
print(fig)
ggsave(filename = paste0(figures_path, "Fig1",  ".jpg"), plot = fig, width = 30, height = 30, units = "cm") 

```

### There is some initial bacterial abundance threshold
We confirm that a sandard phage treatment start eradicting bacteria much sooner when there is high initial bacterial load.
Otherwise, the bacteria may still grow before phages multiplicate enough to become effective.
In natural scenario it may also mean that the phages will decay or be cleared by the system before they start clearing bacteria

```{r,echo=FALSE, fig.show = "hold", out.width = "49%"}

scenario_name = "Fig2_bacteria_high_initial_threshold"
simulated_data =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=highB0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 5)
  if (save_data) {   write.xlsx(simulated_data, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }


dataToPlot_Deafult = simulated_data_default %>% 
  filter(Treatment == "depo-phage (KP34)") %>% 
  filter(time %in% c(0,1)) %>%
  select(time, all_bacteria_CFU_per_mL) %>%
  mutate(Initial.Biomass = "low.bacterial.density")

dataToPlot_HighBiomass = simulated_data %>% 
  filter(Treatment == "depo-phage (KP34)") %>% 
  filter(time %in% c(0,1)) %>%
  select(time, all_bacteria_CFU_per_mL) %>%
  mutate(Initial.Biomass = "high.bacterial.density")

dataToPlot = rbind(dataToPlot_HighBiomass, dataToPlot_Deafult) %>%
  mutate(time = ifelse(time == 0, "Initial", "After 1h")) %>%
  mutate(time = factor(time, levels = c("Initial", "After 1h")))

fig = ggplot(data = dataToPlot) +
  geom_col(aes(x=time, y = all_bacteria_CFU_per_mL), 
           col = "darkblue", fill = "darkblue", width = 0.5) + 
  facet_grid(.~Initial.Biomass) +
  my_theme +
  scale_y_log10() +
  xlab("") +
  ylab("bacteria [CFU/mL]")

print(fig)
ggsave(filename = paste0(figures_path, scenario_name,  ".jpg"), plot = fig, width = fig.width, height = fig.height/2, units = "cm")
```

## We set out to verify if the model can explain our further data
### Kp486+KP15 vs the rest (different bacteria behaviour)
Kp486 is partially resistant to KP15 phage meaning that phage has a smaller burst size after infection of Kp486 than Kp77
Moreover, we notice that Kp486 undergoes a phenotypic change after which it forms some mucoidal cells which happen to be resistant to adsorption of our non-depo phage.
ll together, we observe in the experimental data that the phage cocktail that includes KP15 phage is less effective on Kp486 than on KP77.
Indeed, if we allow in the model a lower burst size and some rate of change between bacteria B1 (with the capsule) and B3 (fully resistant to depo and non-depo phage) we will get some bacterial regrowth under the cocktail treatment.



```{r}
fig =PlotSimulatedPhageAndBacteria(simulated_data_default,
                              title_plot = "Default",
                              colors =colors_no_depo,
                              text_size = text_size)
print(fig)


scenario_name = "Fig3b_high_B1_to_B3_switch"
simulated_data =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=highEpsilonB1toB3, 
                       epsilonB3toB1=highEpsilonB1toB3,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax)

  if (save_data) {   write.xlsx(simulated_data, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }
dataFig3b = simulated_data %>%
               mutate(scenario = "Model result: high rate of change between B_P and B_R")
fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig3b,
                              title_plot = "",
                              colors = colors_no_depo,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size, 
                              legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, scenario_name,  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")

#Note that:  
#
#i)  in the simulations bacteria under the phage cocktail treatment eventually grows to the same density as the bacteria with no phages. 
#In experiments they grow to a smaller density. It may be because:  
#- in the culture after 10-15 hours there is not enough oxygen for the complete regrowth  
#- there may be some fitness costs of becoming mucoidal#
#
#ii)  in the simulations bacteria under the phage cocktail treatment start growing for some short time and then the growth is ceased. 
#In experiments they grow to some small density and stop there. It may be because  
#- phages decay more when trying to adsorb to the 'wrong' bacteria (i.e. non-depo phages trying to adsorb to bacteria with capsule)


```

```{r plot-entire-fig-1, eval = FALSE}
dataFig3 = rbind(final_data_Fig3a %>%  select(time, Treatment, all_bacteria_CFU_per_mL, scenario), 
                 dataFig3b %>% select(time, Treatment, all_bacteria_CFU_per_mL, scenario))
fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig3,
                              title_plot = "",
                              colors = colors_no_depo,
                              ymin= YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2) 
print(fig)
ggsave(filename = paste0(figures_path, "Fig3",  ".jpg"), plot = fig, width = 45, height = 10, units = "cm")

``` 
### Non-depo phage and external depo
We are also able to reproduce the scenario in which depo is added externally to the bacterial culture.
That treatment is also effective although less than the phage cokctail because depo decays with time.


```{r}
 

# check when bacteria decreases under the DEPO as it does for Kp486 + KP15 + depoKP34
depodata = simulated_data_default %>% 
  filter(Treatment == "no-depo-phage+depo (KP15/KP27 + KP34p57)")
dataFig4d = depodata %>% 
             select(time, `Capsulated bacteria` = bacteria_capsule, 
                    `Decapsulated bacteria` = bacteria_no_capsule, 
                    `All bacteria` = all_bacteria_CFU_per_mL) %>%
         tidyr::gather(key = "Bacterial.Type", value = "CFU.Per.mL", 
                       `Capsulated bacteria`, `Decapsulated bacteria`, `All bacteria`) %>%
           mutate(scenario = "(d) Model result: explanation")

fig=ggplot(dataFig4d) +
  geom_line(aes(x=time,y= CFU.Per.mL, col = Bacterial.Type)) +
  scale_y_log10()  +
    xlab("time [h]") +
    ylab("bacteria [CFU/mL]") + 
    scale_y_log10() +
    my_theme + facet_wrap("scenario", ncol =1)

ggsave(filename = paste0(figures_path, "Fig4d_Model_with_depo_explanation",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
print(fig)
```

```{r}
dataFig4c = simulated_data_default %>% 
  mutate(scenario = "Model result")
fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig4c,
                              title_plot = "",
                              ymin= YMIN,
                              ymax = YMAX,
                              text_size = text_size, legend.position = "none")
print(fig)
ggsave(filename = paste0(figures_path, "Fig4c",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
```

```{r plot-entire-fig-4, eval=FALSE}
dataFig4c = simulated_data_default %>% 
  mutate(scenario = "(c) Model result")

dataFig4 = rbind(final_data_Fig4a %>%  select(time, Treatment, all_bacteria_CFU_per_mL, scenario), 
                 final_data_Fig4b %>%  select(time, Treatment, all_bacteria_CFU_per_mL, scenario), 
                 dataFig4c %>%  select(time, Treatment, all_bacteria_CFU_per_mL, scenario))
fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(dataFig4,
                              title_plot = "",
                              ymin= YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2) +
  theme(legend.position = c(0.9,0.1),
        legend.justification  = c(1,0))
print(fig)
ggsave(filename = paste0(figures_path, "Fig4",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")



``` 

### MOI: not much change
The treatments have similar effects for various MOI




```{r, fig.show = "hold", out.width = "33%"}


scenario_name="Fig5c_medium_MOI"
# Finaly evalutate simulation

simulated_data_medium_MOI =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo,                                                            
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =mediumMOI, 
                       G0=G0, 
                       Tmax = Tmax)

if (save_data) {
  write.xlsx(simulated_data_medium_MOI, file=figures_data_path, sheetName = scenario_name, append = TRUE)
}

scenario_name = "Fig5c_low_MOI"
simulated_data_low_MOI =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo,                                                            
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =lowMOI, 
                       G0=G0, 
                       Tmax = Tmax)

if (save_data) {
  write.xlsx(simulated_data_low_MOI, file=figures_data_path, sheetName = scenario_name, append = TRUE)
}
simulated_data_MOI = dplyr::bind_rows(simulated_data_low_MOI %>% mutate(MOI="MOI 0.1"),
                           simulated_data_medium_MOI  %>% mutate(MOI="MOI 1"),
                           simulated_data_default  %>% mutate(MOI="MOI 10"))


  colors_fig_5 = c("depo-phage (KP34)" = "darkgreen",
           "no-depo-phage+depo (KP15/KP27 + KP34p57)" = "darkmagenta",
           "phage cocktail (KP15/KP27 + KP34)" = "darkred")
  
  descriptions_to_show = names(colors_fig_5)
  
  dataFig5c = simulated_data_MOI %>% 
              filter(Treatment %in% descriptions_to_show) %>%
               filter(Treatment != "phage cocktail (KP15/KP27 + KP34)") %>%
              mutate(all_bacteria_CFU_per_mL = ifelse(all_bacteria_CFU_per_mL > minCFU, all_bacteria_CFU_per_mL, minCFU),
                     scenario = "Model result")
  
  fig=ggplot(dataFig5c,
            aes(x = time, y = all_bacteria_CFU_per_mL, col = Treatment, linetype = Treatment, size = Treatment)) +
    scale_color_manual(values=colors_fig_5) +
        scale_linetype_manual(values = linetypes) +
          scale_size_manual(values = linesizes) +
    geom_line() +
    xlab("time [h]") +
    ylab("bacteria [CFU/mL]") + 
    scale_y_log10(limits = c(YMIN, YMAX)) +
    my_theme +
    xlim(c(0,24)) +
    facet_grid(MOI ~scenario) +
    theme(legend.position = "none")
print(fig)
ggsave(filename = paste0(figures_path, "Fig5c_various_MOI",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
```

```{r Fig5, eval = FALSE}

dataFig5abc = rbind(finaldata_Fig5a %>% 
                      select(time, Treatment, all_bacteria_CFU_per_mL=CFU, MOI, scenario), 
                    finaldata_Fig5a %>% 
                      select(time, Treatment, all_bacteria_CFU_per_mL=CFU, MOI, scenario), 
                    dataFig5c %>% 
                      select(time, Treatment, all_bacteria_CFU_per_mL, MOI, scenario))

fig = PlotSimulatedPhageAndBacteria(dataFig5abc, text_size = text_size) +
  facet_grid(MOI ~ scenario) +
  theme(legend.position = "bottom")
print(fig)
ggsave(filename = paste0(figures_path, "Fig5_various_MOI",  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
```

## We use our model to show that the sequential phage cocktail treatment is more effective than the parallel one

### Assuming receptors are lost independently with the same probability 
and that the Non-depo phage can attach to bacteria that lost one specific receptor (no necessarily the other)

```{r}

# here for simplicity we ignore mutations to the fully restistant type
  # B1 - bacteria with both receptors sentitive to Pdepo (attaches to receptor A) and P2 (attaches to receptor B)
  # B2 - bacteria with receptor A, and lost receptor B, sensitive to Pdepo (attaches to receptor A)
  # B3 - bacteria with receptor B, and lost receptor A, sensitive to Pnondepo (attaches to the lost receptor A) and P2 (attaches to receptor B)
  # B4 - bacteria without either:lost receptor A and B, sensitive to Pnondepo (attaches to the lost receptor A)
  
  # Pdepo (attaches to receptor A and encodes depo) therefore it makes some of the bacteria loose that receptor and still keep alive if we assume c > 0!
  # P2 (attaches to receptor B)
  # Pnondepo (attaches to the lost receptor A and doesn;t encode depo) 


  colors2 = c("no phage" = "black",
               "Sequential cocktail" = "red",
               "Simultaneous cocktail" = "darkblue")
  descriptions = names(colors2)
  epsilon_compare_models = 10^(-3)
  
  
beta2 = beta_non_depo
phi2 = phi_non_depo
  pars =  c(a = a, 
            Vh = Vh, 
            Kh = Kh,
            beta_non_depo = beta_non_depo, 
            beta2 = beta2,
            beta_depo = beta_depo, 
            phi_non_depo = phi_non_depo, 
            phi2 = phi2, 
            phi_depo = phi_depo,
            decay = decay, 
            bf = 1,
            epsilonB2toB1 = 0,#epsilon, 
            epsilonB1toB2 = epsilon_compare_models,
            epsilonB2toB4 = epsilon_compare_models,
            epsilonB4toB2 = 0,#epsilon,
            epsilonB1toB3 = epsilon_compare_models,
            epsilonB3toB1 = 0,#epsilon,
            epsilonB3toB4 = epsilon_compare_models,
            epsilonB4toB3 = 0#epsilon
            )
  
  time = seq(0,Tmax,0.1)
  P0=B0*MOI;  
inits = 
            c(G = G0, 
              Pdepo = 0.5*P0,
              P2 = 0,
              Pnondepo = 0.5*P0,
              B1= B0,
              B2 = 0,
              B3 = 0,
              B4 = 0)

    simulation <- as.data.frame(ode(inits, time, two_simultaneous_phages_and_bacteria_with_two_receptors, pars))%>%
      mutate(all.bacteria = B1+B2+ B3+B4) %>%
      rename(`Bacteria.Receptors.A&B` = B1,
             `Bacteria.Receptor.A` = B2,
             `Bacteria.Receptor.B` = B3,
             `Bacteria.No.Receptors` = B4,
             ) %>%
      tidyr::gather(key = "Bacteria.Type", value = biomass, -time, -G,-Pdepo,-P2, -Pnondepo) %>%
      mutate(description = descriptions[2],
             CFU= biomass*mg_count/1000)
    simulated_data = simulation
    
    inits['Pdepo'] = 0
    inits['Pnondepo'] = 0
    simulation <- as.data.frame(ode(inits, time, two_simultaneous_phages_and_bacteria_with_two_receptors, pars))%>%
      mutate(all.bacteria = B1+B2+ B3+B4) %>%
            rename(`Bacteria.Receptors.A&B` = B1,
             `Bacteria.Receptor.A` = B2,
             `Bacteria.Receptor.B` = B3,
             `Bacteria.No.Receptors` = B4,
             )%>%
      tidyr::gather(key = "Bacteria.Type", value = biomass, -time, -G,-Pdepo,-P2, -Pnondepo) %>%
      mutate(description = descriptions[1],
             CFU= biomass*mg_count/1000)
    simulated_data = rbind(simulated_data, simulation)
    
    inits['Pdepo'] = 0.5*P0
    inits['Pnondepo'] = 0
    inits['P2'] = 0.5*P0
    simulation <- as.data.frame(ode(inits, time, two_simultaneous_phages_and_bacteria_with_two_receptors, pars))%>%
      mutate(all.bacteria = B1+B2+ B3+B4) %>%
            rename(`Bacteria.Receptors.A&B` = B1,
             `Bacteria.Receptor.A` = B2,
             `Bacteria.Receptor.B` = B3,
             `Bacteria.No.Receptors` = B4,
             )%>%
      tidyr::gather(key = "Bacteria.Type", value = biomass, -time, -G,-Pdepo,-P2, -Pnondepo) %>%
      mutate(description = descriptions[3],
             CFU= biomass*mg_count/1000)
    simulated_data = rbind(simulated_data, simulation) 
  
  scenario_name = "Fig6_compare_traditional_cocktails"#
  

    if (save_data) {   write.xlsx(simulated_data, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }
  
  g=ggplot(simulated_data %>% 
             filter(Bacteria.Type == "all.bacteria") %>%
             mutate(`Treatment type` = description,
                    scenario = "Comparison of sequential and simultaneous phage cocktails" ) %>%
             rowwise() %>%
                mutate(CFU = max(CFU, minCFU)), 
         aes(x = time, y = CFU, col = `Treatment type`)) +
    #scale_color_manual(values=colors) +
    geom_line() + 
    #theme_bw() +      
    scale_color_manual(values=colors2) +
    my_theme +
    facet_grid(.~scenario) +
    ylab("bacteria [CFU/mL]") +
    scale_y_log10(limits = c(YMIN, YMAX))
  ggsave(filename = paste0(figures_path, "Fig6a_Traditional_cocktail_comparison1",  ".jpg"), plot = g, width = fig.width, height = fig.height, units = "cm")
  print(g)
  

  dataFig6bcd = simulated_data %>% 
             filter(Bacteria.Type != "all.bacteria") %>%
             mutate(description = ifelse(description == "no phage", 
                                         "no phage",
                                         ifelse(description == "Sequential cocktail", 
                                                "Sequential cocktail",
                                                "Simultaneous cocktail"
                                                )))
                    
  g=ggplot(dataFig6bcd, 
         aes(x=time, y=CFU, col = Bacteria.Type)) +
    geom_line() +
    my_theme +
    facet_grid(. ~ description) +
    ylab("bacteria [CFU/mL]")
  
  # legend only
    leg = ggpubr::get_legend(g)
    l=ggpubr::as_ggplot(leg)


  ggsave(filename = paste0(figures_path, "Fig6bcd_Traditional_cocktail_comparison",  ".jpg"),
         plot = g + theme(legend.position = "bottom"),#+ theme(legend.position = "none")
         width = 45, height = 10, units = "cm")
  
    ggsave(filename = paste0(figures_path, "Fig6bcd_Traditional_cocktail_comparison_legend",  ".jpg"), plot = l,width = fig.width, height = fig.height, units = "cm")
  print(g)
  
  
   g=ggplot(dataFig6bcd %>% 
              filter(description == "no phage") %>%
                              rowwise() %>%
                mutate(CFU = max(CFU, minCFU)), 
         aes(x=time, y=CFU, col = Bacteria.Type)) +
    geom_line() +
    my_theme +
    facet_grid(. ~ description) +
    ylab("bacteria [CFU/mL]") +
     #ylim(c(YMIN, YMAX))
    scale_y_log10(limits = c(YMIN, YMAX))
       ggsave(filename = paste0(figures_path, "Fig6b",  ".jpg"), plot = g,width = fig.width, height = fig.height, units = "cm")
  print(g)
  
     g=ggplot(dataFig6bcd %>% 
                filter(description == "Sequential cocktail") %>%
                rowwise() %>%
                mutate(CFU = max(CFU, minCFU)), 
         aes(x=time, y=CFU, col = Bacteria.Type)) +
    geom_line() +
    my_theme +
    facet_grid(. ~ description) +
    ylab("bacteria [CFU/mL]")+
    scale_y_log10(limits = c(YMIN, YMAX))
    #ylim(c(0.9*YMIN, YMAX))
       ggsave(filename = paste0(figures_path, "Fig6d",  ".jpg"), plot = g,width = fig.width, height = fig.height, units = "cm")
  print(g)
  
     g=ggplot(dataFig6bcd %>% 
                filter(description == "Simultaneous cocktail") %>%
                rowwise() %>%
                mutate(CFU = max(CFU, minCFU)), 
         aes(x=time, y=CFU, col = Bacteria.Type)) +
    geom_line() +
    my_theme +
    facet_grid(. ~ description) +
    ylab("bacteria [CFU/mL]")+
    scale_y_log10(limits = c(YMIN, YMAX))
    # ylim(c(YMIN, YMAX))
       ggsave(filename = paste0(figures_path, "Fig6c",  ".jpg"), plot = g,width = fig.width, height = fig.height, units = "cm")
  print(g)
```

## Choice of phages and time horizon 

### Choice of the depo phage
If the phage with depo is less efficient at infecting the capsuled bacteria, the bacteria will initially grow before phages multiplicate enough to infect the bacteria. This may be unwanted in real treatments.
Interestingly though, such a change may decrease the final bacteria load in long term. This is because bacteria in our experiment grow in a batch culture and their initial growth will result in a decrease in the resource they can use later.

```{r,echo=FALSE}
scenario_name = "Fig7a_low_depo_adsorption"
simulated_data_Fig7a =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=low_phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax)

if (save_data) {write.xlsx(simulated_data_Fig7a, file=figures_data_path, sheetName = scenario_name, append = TRUE)}


scenario_name = "Fig7b_low_depo_burst"
simulated_data_Fig7b =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=low_beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax)
if (save_data) {write.xlsx(simulated_data_Fig7b, file=figures_data_path, sheetName = scenario_name, append = TRUE)}

```

### Choice of the non-depo phage
If the phage without depo is less efficient at infecting the uncapsuled bacteria, the uncapsuled bacteria that will appear after a couple of hours in the populatiom will initially grow before phages multiplicate enough to infect the bacteria. Again, this may be unwanted in real treatments.
Interestingly though, such a change may decrease the final bacteria load in long term. This happens if the resources bacteria can use for growth are limited as in the caae of our expeirment

```{r,echo=FALSE}
scenario_name = "Fig7c_low_non_depo_adsorption"
simulated_data_low_phi_non_depo =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=low_phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax)
if (save_data) {   write.xlsx(simulated_data_low_phi_non_depo, file=figures_data_path, sheetName = scenario_name, append = TRUE)}



scenario_name="Fig7d_low_non_depo_burst"
simulated_data_Fig7d =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=low_beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax)
  if (save_data) {   write.xlsx(simulated_data, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }


all_fig7_data =
     simulated_data_Fig7a %>% 
      mutate(scenario  = "(a) Low P_P adsorption rate") %>%
     rbind(simulated_data_Fig7b %>% mutate(scenario  = "(b) Low P_P burst size"))  %>%
     rbind(simulated_data_low_phi_non_depo %>% mutate(scenario  = "(c) Low P_N adsorption rate")) %>%
     rbind(simulated_data_Fig7d %>% mutate(scenario  = "(d) Low P_N burst size"))



fig=PlotSimulatedPhageAndBacteriaMultipleScenarios(all_fig7_data,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, 'Fig7',  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")

fig=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig7a %>% 
      mutate(scenario  = "Low P_P adsorption rate") ,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, 'Fig7a',  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")

fig=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig7b %>% 
      mutate(scenario  = "Low P_P burst size") ,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, 'Fig7b',  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")

fig=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_low_phi_non_depo %>% 
      mutate(scenario  = "Low P_N adsorption rate") ,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig)
ggsave(filename = paste0(figures_path, 'Fig7c',  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")

fig=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig7d %>% 
      mutate(scenario  = "Low P_N burst size") ,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") #+
  ##guides(color=guide_legend(nrow=2,byrow=TRUE)) +
  #theme(legend.position = "bottom")

print(fig)
ggsave(filename = paste0(figures_path, 'Fig7d',  ".jpg"), plot = fig, width = fig.width, height = fig.height, units = "cm")
```

### Proportion of phages
Manipulation of the initial phage frequency may be useful when we know one of the phages is weaker than the other.
For example if the non depo phage has a low burst size and we add more of it to the mixture then we keep the bacteria load lower for a longer time than when mixing phages in the proportion 1:1.

```{r,echo=FALSE, fig.show = "hold", out.width = "32%"}


scenario_name = "Fig8c_low_propPP_low_non_depo_adsorption"
simulated_data_Fig8c =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=low_phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = Tmax, 
                       propPP = lowPropPP)

if (save_data) {
  write.xlsx(simulated_data_Fig8c, file=figures_data_path, sheetName = scenario_name, append = TRUE)
}


all_fig8_data =
     simulated_data_default %>% 
      mutate(scenario  = "(a) Standard (default parameters)") %>%
     rbind(simulated_data_low_phi_non_depo %>% mutate(scenario  = "(b) Low P_N  adsorption rate"))  %>%
     rbind(simulated_data_Fig8c %>% mutate(scenario  = "(c) Low P_N adsorption rate & low proportion of P_P")) 


fig8=PlotSimulatedPhageAndBacteriaMultipleScenarios(all_fig8_data,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size, 
                              ncol = 2,
      legend.position = "none") +
  theme(legend.position = c(0.9,0.2),
        legend.justification = c(1,0))
print(fig8)
ggsave(filename = paste0(figures_path, 'Fig8',  ".jpg"), plot = fig8, width = fig.width, height = fig.height, units = "cm")

fig8=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_default %>%
                                                      mutate(scenario = "Standard (default parameters)"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size, 
                              ncol = 2,
      legend.position = "none") 
print(fig8)
ggsave(filename = paste0(figures_path, 'Fig8a',  ".jpg"), plot = fig8, width = fig.width, height = fig.height, units = "cm")

fig8=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_low_phi_non_depo %>% 
                                                      mutate(scenario  = "Low P_N  adsorption rate"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size, 
                              ncol = 2,
      legend.position = "none") 
print(fig8)
ggsave(filename = paste0(figures_path, 'Fig8b',  ".jpg"), plot = fig8, width = fig.width, height = fig.height, units = "cm")

fig8=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig8c %>% 
                                                      mutate(scenario  = "Low P_N adsorption rate & low proportion of P_P"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size, 
                              ncol = 2,
      legend.position = "none") 
print(fig8)
ggsave(filename = paste0(figures_path, 'Fig8c',  ".jpg"), plot = fig8, width = fig.width, height = fig.height, units = "cm")

```


## Eventually we explore some further unintuitive scenarios and the robustness of our phage cocktail treatment

### The efficiency of the phage cocktail is relatively robust to initial bacteria biomass  
The external depo & non-phage therapy seems to be more efficient at high bacterial load
and bacteria start re-growing later at very load bacterial load. The combined phage treatment results in all cases in no bacterial growth for the first 24 hours

```{r,echo=FALSE, fig.show = "hold", out.width = "33%"}
scenario_name = "Fig9b_low_initial_biomass"
simulated_data_Fig9b =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=lowB0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24)

if (save_data) {write.xlsx(simulated_data_Fig9b, file=figures_data_path, sheetName = scenario_name, append = TRUE)}



scenario_name = "Fig9c_high_initial_biomass"
simulated_data_Fig9c =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=highB0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24)

if (save_data) {write.xlsx(simulated_data_Fig9c, file=figures_data_path, sheetName = scenario_name, append = TRUE)}



all_fig9_data =
     simulated_data_default %>% 
      mutate(scenario  = "(a) Standard initial biomass") %>%
     rbind(simulated_data_Fig9b %>% mutate(scenario  = "(b) Low initial biomass"))  %>%
     rbind(simulated_data_Fig9c %>% mutate(scenario  = "(c) High initial biomass")) 


fig9=PlotSimulatedPhageAndBacteriaMultipleScenarios(all_fig9_data,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig9)
ggsave(filename = paste0(figures_path, 'Fig9',  ".jpg"), plot = fig9, width = fig.width, height = fig.height, units = "cm")


fig9=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_default %>% 
      mutate(scenario  = "Standard initial biomass") ,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig9)
ggsave(filename = paste0(figures_path, 'Fig9a',  ".jpg"), plot = fig9, width = fig.width, height = fig.height, units = "cm")

fig9=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig9b %>% mutate(scenario  = "Low initial biomass") ,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig9)
ggsave(filename = paste0(figures_path, 'Fig9b',  ".jpg"), plot = fig9, width = fig.width, height = fig.height, units = "cm")

fig9=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig9c %>% mutate(scenario  = "High initial biomass") ,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig9)
ggsave(filename = paste0(figures_path, 'Fig9c',  ".jpg"), plot = fig9, width = fig.width, height = fig.height, units = "cm")
```

### The efficiency of the phage cocktail is partially robust to initial resource concentration
For a range of resource concentrations the phage cocktail is effective, however when there a lot of resource and the growth dynamics is very quick, the fully resistant mutants appear sooner and they can be observed within the 24 hours growth.


```{r,echo=FALSE, fig.show = "hold", out.width = "33%"}
scenario_name = "Fig10a_low_initial_glucose"
simulated_data_Fig10a =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=lowG0, 
                       Tmax = 24)
if (save_data) {write.xlsx(simulated_data_Fig10a, file=figures_data_path, sheetName = scenario_name, append = TRUE)}



scenario_name = "Fig10c_high_initial_glucose"
simulated_data_Fig10c =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=highG0, 
                       Tmax = 24)
if (save_data) {write.xlsx(simulated_data_Fig10c, file=figures_data_path, sheetName = scenario_name, append = TRUE)}



all_fig10_data =
     simulated_data_default %>% 
      mutate(scenario  = "(b) Standard initial glucose") %>%
     rbind(simulated_data_Fig10a %>% mutate(scenario  = "(a) Low initial glucose"))  %>%
     rbind(simulated_data_Fig10c %>% mutate(scenario  = "(c) High initial glucose")) 


fig10=PlotSimulatedPhageAndBacteriaMultipleScenarios(all_fig10_data,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2) +
  theme(legend.position = c(0.9,0.2),
        legend.justification = c(1,0))
print(fig10)
ggsave(filename = paste0(figures_path, 'Fig10',  ".jpg"), plot = fig10, width = fig.width, height = fig.height, units = "cm")

fig10=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_default %>% 
      mutate(scenario  = "Standard initial glucose"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig10)
ggsave(filename = paste0(figures_path, 'Fig10b',  ".jpg"), plot = fig10, width = fig.width, height = fig.height, units = "cm")

fig10=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig10a %>% mutate(scenario  = "Low initial glucose"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig10)
ggsave(filename = paste0(figures_path, 'Fig10a',  ".jpg"), plot = fig10, width = fig.width, height = fig.height, units = "cm")

fig10=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig10c %>% mutate(scenario  = "High initial glucose"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = 2*YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig10)
ggsave(filename = paste0(figures_path, 'Fig10c',  ".jpg"), plot = fig10, width = fig.width, height = fig.height, units = "cm")

```

### The efficiency of the phage cocktail is robust to the switch rate between capsuled and uncapsuled strains 
WHile the standard treatment fails sooner when the rate of change between bacteria with and without capsule, it does not affect the phage cocktail treatment

```{r,echo=FALSE, fig.show = "hold", out.width = "33%"}
scenario_name = "Fig11a_low_B1_B2_mutation"
simulated_data_Fig11a =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=lowepsilonB2toB1, 
                       epsilonB1toB2=lowepsilonB2toB1,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24)
if (save_data) {write.xlsx(simulated_data_Fig11a, file=figures_data_path, sheetName = scenario_name, append = TRUE)}




scenario_name = "Fig11b_high_B1_B2_mutation"
simulated_data_Fig11b =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=highepsilonB2toB1, 
                       epsilonB1toB2=highepsilonB2toB1,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24)
if (save_data) {write.xlsx(simulated_data_Fig11b, file=figures_data_path, sheetName = scenario_name, append = TRUE)}


all_fig11_data =
     rbind(simulated_data_Fig11a %>% mutate(scenario  = "(a) Low rate of change between B_P and B_N"))  %>%
     rbind(simulated_data_Fig11b %>% mutate(scenario  = "(b) high rate of change between B_P and B_N")) 


fig11=PlotSimulatedPhageAndBacteriaMultipleScenarios(all_fig11_data,
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig11)
ggsave(filename = paste0(figures_path, 'Fig11',  ".jpg"), plot = fig11, width = fig.width, height = fig.height, units = "cm")


fig11=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig11a %>% mutate(scenario  = "Low rate of change between B_P and B_N"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig11)
ggsave(filename = paste0(figures_path, 'Fig11a',  ".jpg"), plot = fig11, width = fig.width, height = fig.height, units = "cm")


fig11=PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data_Fig11b %>% mutate(scenario  = "High rate of change between B_P and B_N"),
                              title_plot = "",
                              colors = colors,
                              ymin=YMIN,
                              ymax = YMAX,
                              text_size = text_size,
                              ncol = 2,
      legend.position = "none") 
print(fig11)
ggsave(filename = paste0(figures_path, 'Fig11b',  ".jpg"), plot = fig11, width = fig.width, height = fig.height, units = "cm")

```


### The cocktail therapy is going to fail in long term if bacteria are able to quickly mutate to the fully resistant strain   


```{r,echo=FALSE, fig.show = "hold", out.width = "49%"}
scenario_name = "Fig12_very_high_epsilon_NR"
simulated_data =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=highepsilontoB3, 
                       epsilonB3toB2=highepsilontoB3,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24)

  if (save_data) {   write.xlsx(simulated_data, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }
fig =PlotSimulatedPhageAndBacteria(simulated_data,
                              title_plot = "",
                              colors = colors,
                              text_size = text_size)
  #theme(legend.position = "none")

print(fig)
ggsave(filename = paste0(figures_path, scenario_name,  ".jpg"), plot = fig, width = 2*fig.width, height = fig.height, units = "cm")

```

# Sensitivity on depo params
```{r,echo=FALSE, fig.show = "hold", out.width = "49%"}
scenario_name = "FigS1_depo_sensitivity_low_V"
simulated_data_lowVdepo =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo/2, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24) %>%
  mutate(scenario = "g) low V")

  if (save_data) {   write.xlsx(simulated_data_lowVdepo, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }

scenario_name = "FigS1_depo_sensitivity_high_V"

simulated_data_highVdepo =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo*2, 
                       K_depo=K_depo, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24) %>%
  mutate(scenario = "d) high V")

  if (save_data) {   write.xlsx(simulated_data_highVdepo, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }

scenario_name = "FigS1_depo_sensitivity_high_K"
simulated_data_highKdepo =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo*2, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24) %>%
  mutate(scenario = "c) high K")

  if (save_data) {   write.xlsx(simulated_data_highKdepo, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }

scenario_name = "FigS1_depo_sensitivity_low_K"
simulated_data_lowKdepo =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo/2, 
                       depo_decay_rate=depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24) %>%
  mutate(scenario = "f) low K")

  if (save_data) {   write.xlsx(simulated_data_lowKdepo, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }

scenario_name = "FigS1_depo_sensitivity_high_decay"
simulated_data_high_decay =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=2*depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24) %>%
  mutate(scenario = "b) High decay rate")
  if (save_data) {   write.xlsx(simulated_data_high_decay, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }

scenario_name = "FigS1_depo_sensitivity_low_decay"
simulated_data_low_decay =Simulate_Phage_Coctail(Vh=Vh, 
                       Kh=Kh,
                       a=a, 
                       beta_non_depo=beta_non_depo, 
                       beta_depo=beta_depo, 
                       phi_non_depo=phi_non_depo, 
                       phi_depo=phi_depo, 
                       decay=decay, 
                       V_depo=V_depo, 
                       K_depo=K_depo, 
                       depo_decay_rate=0.5*depo_decay_rate,
                       epsilonB2toB1=epsilonB2toB1, 
                       epsilonB1toB2=epsilonB1toB2,
                       epsilonB2toB3=epsilonB2toB3, 
                       epsilonB3toB2=epsilonB3toB2,
                       epsilonB1toB3=epsilonB1toB3, 
                       epsilonB3toB1=epsilonB3toB1,  
                       B0=B0, 
                       e0=e0, 
                       MOI =MOI, 
                       G0=G0, 
                       Tmax = 24) %>%
  mutate(scenario = "e) low decay rate")
  if (save_data) {   write.xlsx(simulated_data_low_decay, file=figures_data_path, sheetName = scenario_name, append = TRUE)   }


simulated_data_default$scenario = "a) default"
simulated_data = rbind(simulated_data_lowVdepo,simulated_data_default, simulated_data_highVdepo,
                       simulated_data_lowKdepo, simulated_data_highKdepo,
                       simulated_data_high_decay, simulated_data_low_decay)

fig =PlotSimulatedPhageAndBacteriaMultipleScenarios(simulated_data,
                              title_plot = "",
                              colors = colors,
                              text_size = 10,ncol = 2) +
  theme(legend.position = c(0.99,0.01),
        legend.justification = c(1,0))
print(fig)
ggsave(filename = paste0(figures_path, "FigS3",  ".jpg"), plot = fig, width = fig.width, height = 2*fig.height, units = "cm")

```


